/*
Notes:
- setiap id akan diubah menjadi string
- terdapat 2 versi tipe data tanggal (date dan string)
- perhitungan nett sales dan nett profit dihitung berdasarkan diskon dan persentase laba
*/

SELECT
    CAST(ft.transaction_id AS STRING) AS transaction_id,          -- diubah ke bentuk string
    ft.date,                                                   -- tanggal asli (tipe data DATE) untuk visualisasi time series
    CAST(FORMAT_DATE('%d/%m/%Y', ft.date) AS STRING) AS date_str, -- tanggal diubah ke bentuk string untuk label tabel
    CAST(ft.branch_id AS STRING) AS branch_id,                    -- diubah ke bentuk string
    kc.branch_name,
    kc.kota,
    kc.provinsi,
    kc.rating as rating_cabang,
    ft.customer_name,
    CAST(ft.product_id AS STRING) AS product_id,                  -- diubah ke bentuk string
    p.product_name,
    p.price as actual_price,
    ft.discount_percentage,

    -- Persentase gross laba
    CASE 
        WHEN p.price <= 50000 THEN 0.10
        WHEN p.price > 50000 AND p.price <= 100000 THEN 0.15
        WHEN p.price > 100000 AND p.price <= 300000 THEN 0.20
        WHEN p.price > 300000 AND p.price <= 500000 THEN 0.25
        WHEN p.price > 500000 THEN 0.30
    END AS persentase_gross_laba,

    -- Harga setelah diskon
    p.price * (1 - ft.discount_percentage/100.0) AS nett_sales,

    -- Laba setelah diskon
    (p.price * (1 - ft.discount_percentage/100.0)) *
    CASE 
        WHEN p.price <= 50000 THEN 0.10
        WHEN p.price > 50000 AND p.price <= 100000 THEN 0.15
        WHEN p.price > 100000 AND p.price <= 300000 THEN 0.20
        WHEN p.price > 300000 AND p.price <= 500000 THEN 0.25
        WHEN p.price > 500000 THEN 0.30
    END AS nett_profit,

    ft.rating  -- rating transaksi dengan tipe data num

-- Bagian FROM + JOIN
FROM `rakamin-kf-analytics-470312.kimia_farma.kf_final_transaction` AS ft
LEFT JOIN `rakamin-kf-analytics-470312.kimia_farma.kf_kantor_cabang` AS kc
    ON ft.branch_id = kc.branch_id
LEFT JOIN `rakamin-kf-analytics-470312.kimia_farma.kf_product` AS p
    ON ft.product_id = p.product_id
;
